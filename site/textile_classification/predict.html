<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Predict - Home</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Predict";
        var mkdocs_page_input_path = "textile_classification\\predict.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Home
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Textile Classification</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="train.html">Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="test.html">Test</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="predict.html">Predict</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Data_Setters</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="data_setters/create_csv_files.html">Create_CSV_Files</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="data_setters/data_set_creator.html">Data_Set_Creator</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Models</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="models/pretrained_densenet.html">DenseNet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="models/pretrained_efficientnet.html">EfficientNet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="models/pretrained_resnext.html">ResNeXt</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Utils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="utils/data_set_visualization.html">Data_Set_Visualization</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="utils/metric_calculation_visualization.html">Metric_Calculation_Visualization</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="utils/miscellaneous.html">miscellaneous</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="utils/model_tracking.html">model_tracking</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Home</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Textile Classification &raquo;</li>
      <li>Predict</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/srahmatian/texture_classification/edit/master/docs/textile_classification/predict.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">


<a id="textile_classification.predict"></a>
  <div class="doc doc-contents first">
  
      <p>Use this python file to predict the labels of unseen images using a trained model.
It classifies the images located in the your provided directroy file, and
separate them into subfolders named valid and invalid based on their predicted labels.
Use this file when you don't know the ground truths for the labes.
Note that you have to pass a .cfg file as the a argument when you want to run this file.
That .cfg file must contain required information for the prediction like images_dir and the checkpoint of trained model.
Pleae take a look at predict_input_info.cfg as a template.
You can create your own .cfg file with another name or just change the content of predict_input_info.cfg
This is an example how you can test the model:</p>
<p>python .        extile_classification\predict.py .      extile_classification\predict_input_info.cfg</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="textile_classification.predict.predict_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">predict_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds_prediction</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Use this function to test the performance of the model on unseen images, and
you don't know their true labes.
So there is no metric calculation here. 
This function create two subfolders (valid, invalid) in the directory of input images, and 
put them there based on its prediction.
It also create a csv file name prediction.csv and store it there.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code><span title="torch.nn">nn</span>.<span title="torch.nn.Module">Module</span></code>
          </td>
          <td><p>The model that is loaded by a checkoint</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ds_prediction</code></td>
          <td>
                <code><span title="torch.utils.data.Dataset">Dataset</span></code>
          </td>
          <td><p>We don't need to pass data loader since we pass the images one by one</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>It should be between zero and one.
                         if the probability of the prediced label is more than threshold, 
                         the image is considered as valid image, otherwise it is invalid.</p></td>
          <td>
                <code>0.5</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>textile_classification\predict.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_model</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ds_prediction</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use this function to test the performance of the model on unseen images, and</span>
<span class="sd">    you don&#39;t know their true labes.</span>
<span class="sd">    So there is no metric calculation here. </span>
<span class="sd">    This function create two subfolders (valid, invalid) in the directory of input images, and </span>
<span class="sd">    put them there based on its prediction.</span>
<span class="sd">    It also create a csv file name prediction.csv and store it there.</span>


<span class="sd">    Args:</span>
<span class="sd">        model (nn.Module): The model that is loaded by a checkoint</span>
<span class="sd">        ds_prediction (Dataset): We don&#39;t need to pass data loader since we pass the images one by one</span>
<span class="sd">        threshold (float, optional): It should be between zero and one.</span>
<span class="sd">                                     if the probability of the prediced label is more than threshold, </span>
<span class="sd">                                     the image is considered as valid image, otherwise it is invalid. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># fot testing the model, we need to remove dropout, fix batch_normalization, and etc using eval()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">labels_predicted_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ds_predict_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_prediction</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds_predict_size</span><span class="p">):</span>
            <span class="c1"># note that targets are nan in predication phase</span>
            <span class="n">input_target</span> <span class="o">=</span> <span class="n">ds_prediction</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="c1"># data_set returns tensor without having a dimension related to batch, so</span>
            <span class="c1"># to feed the data into model, we need to unsqueeze them.</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">input_target</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">label_predicted</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">labels_predicted_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_predicted</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">25</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num_feeded_data/num_whole_data: [</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ds_predict_size</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="n">labels_predicted_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">labels_predicted_all</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">labels_predicted_all</span> <span class="o">=</span> <span class="n">change_labels_from_one_hot_fromat_to_binary_format</span><span class="p">(</span><span class="n">labels_predicted_all</span><span class="p">)</span>
        <span class="n">labels_predicted_all</span> <span class="o">=</span> <span class="n">change_labels_from_probablity_format_to_deterministic_format</span><span class="p">(</span>
            <span class="n">labels_predicted_all</span><span class="p">,</span> 
            <span class="n">is_one_hot_format</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>

        <span class="c1"># separate images intp valid and invalid folders</span>
        <span class="n">images_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ds_prediction</span><span class="o">.</span><span class="n">data_frame_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;image_path&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span>

        <span class="n">valid_dir</span> <span class="o">=</span> <span class="n">images_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
        <span class="n">valid_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">invalid_dir</span> <span class="o">=</span> <span class="n">images_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> 
        <span class="n">invalid_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds_predict_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">labels_predicted_all</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ds_prediction</span><span class="o">.</span><span class="n">data_frame_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;valid&quot;</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ds_prediction</span><span class="o">.</span><span class="n">data_frame_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;image_path&quot;</span><span class="p">])</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">valid_dir</span><span class="p">)</span>
                <span class="n">ds_prediction</span><span class="o">.</span><span class="n">data_frame_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;image_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">image_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds_prediction</span><span class="o">.</span><span class="n">data_frame_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;invalid&quot;</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ds_prediction</span><span class="o">.</span><span class="n">data_frame_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;image_path&quot;</span><span class="p">])</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">invalid_dir</span><span class="p">)</span>
                <span class="n">ds_prediction</span><span class="o">.</span><span class="n">data_frame_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;image_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invalid_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">image_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># create csv file for the data_frame</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">images_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;prediction.csv&quot;</span><span class="p">)</span>
        <span class="n">ds_prediction</span><span class="o">.</span><span class="n">data_frame_pd</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Prediction is Done&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="test.html" class="btn btn-neutral float-left" title="Test"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="data_setters/create_csv_files.html" class="btn btn-neutral float-right" title="Create_CSV_Files">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/srahmatian/texture_classification" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="test.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="data_setters/create_csv_files.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
